# @cjsx React.DOM

debug = require('debug')("cobudget-ui:app:views:app")
React = require('react')
_ = require('lodash')

Fluxxor = require('fluxxor')
FluxMixin = Fluxxor.FluxMixin(React)
StoreWatchMixin = Fluxxor.StoreWatchMixin

Router = require('react-router')
CurrentPath = Router.CurrentPath
Navigation = Router.Navigation

Nav = require('./nav.coffee')

module.exports = React.createClass
  mixins: [
    FluxMixin, StoreWatchMixin("Budgets"),
    CurrentPath, Navigation
  ]

  getStateFromFlux: ->
    flux = @getFlux()

    Budgets = flux.store("Budgets")
    budgets = Budgets.budgets

    { Budgets, budgets }

  componentDidMount: () ->
    debug("componentDidMount", @state, @props)
    
    Budgets = @state.Budgets
    path = @getCurrentPath()

    # if path is at root
    if path == "/"
      # when budgets are loaded,
      Budgets.once "change", =>
        # update route to /budgets/:budgetId
        # where budgetId is first budget
        firstBudgetId = Budgets.budgets[0].id
        debug("updating route to first budget", firstBudgetId)
        @replaceWith("budget", budgetId: firstBudgetId)


  render: ->
    debug("render'ing", @state, @props)

    return (
      <div>
        <header>
          <Nav budgets={@state.budgets} />
        </header>
        <main>
          <this.props.activeRouteHandler />
        </main>
      </div>
    )
