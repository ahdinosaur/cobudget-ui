# @cjsx React.DOM

debug = require('debug')("cobudget-ui:app")
React = require('react')
Fluxxor = require('fluxxor')
_ = require('lodash')

NavBar = require('nav/views/bar.coffee')

FluxMixin = Fluxxor.FluxMixin(React)
StoreWatchMixin = Fluxxor.StoreWatchMixin

routes = require('routes')

module.exports = React.createClass
  mixins: [FluxMixin, StoreWatchMixin("Nav", "Budgets")]

  getStateFromFlux: ->
    flux = this.getFlux()

    Nav = flux.store("Nav")
    Budgets = flux.store("Budgets")

    path = Nav.path
    budgets = Budgets.budgets

    # return at least what is necessary for nav bar
    ret  = { path, budgets }

    # get current route, if any
    route = Nav.pathToRoute(Nav.path)

    if route != null
      # return state from route
      state = routes[route.name].state(flux, route.params)

      # add route state to what we will return
      _.extend(ret, { state, route })

    ret

  render: ->
    debug("render'ing App", @state)

    if route
      page = @state.route.page(@state.state)

      return (
        <div>
          <NavBar path={@state.path} budgets={@state.budgets} />
          {page}
        </div>
      )
    else
      return (
        <div>
        </div>
      )
